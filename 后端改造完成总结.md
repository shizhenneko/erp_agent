# ERP Agent åç«¯æ”¹é€ å®Œæˆæ€»ç»“

## âœ… åç«¯æ”¹é€ å·²å…¨éƒ¨å®Œæˆï¼

### æ”¹é€ å†…å®¹

1. **åŸå§‹æ–‡ä»¶å¤‡ä»½** âœ…
   - å¤‡ä»½ä½ç½®: `erp_agent/main.py.backup`
   - ä¿ç•™äº†åŸå§‹å‘½ä»¤è¡Œäº¤äº’ç‰ˆæœ¬çš„å®Œæ•´ä»£ç 

2. **FastAPI WebSocket æœåŠ¡** âœ…
   - æ”¹é€ æ–‡ä»¶: `erp_agent/main.py`
   - æ–°å¢ WebSocket ç«¯ç‚¹: `/ws`
   - ä¿ç•™æ‰€æœ‰åŸæœ‰çš„ Agent åŠŸèƒ½

3. **ä¾èµ–ç®¡ç†** âœ…
   - æ›´æ–°: `requirements.txt`
   - æ–°å¢ä¾èµ–: fastapi, uvicorn, websockets

4. **å¯åŠ¨è„šæœ¬** âœ…
   - åç«¯å¯åŠ¨: `start_backend.bat`
   - å‰ç«¯å¯åŠ¨: `start_frontend.bat`

---

## ğŸ“¦ æ”¹é€ åçš„åŠŸèƒ½ç‰¹æ€§

### æ–°å¢ API ç«¯ç‚¹

#### 1. æ ¹è·¯å¾„ `GET /`
```json
{
  "name": "ERP Agent WebSocket API",
  "version": "0.1.0",
  "description": "åŸºäº ReAct èŒƒå¼çš„æ™ºèƒ½æ•°æ®æŸ¥è¯¢åŠ©æ‰‹",
  "endpoints": {
    "websocket": "/ws"
  }
}
```

#### 2. å¥åº·æ£€æŸ¥ `GET /health`
```json
{
  "status": "healthy",
  "agent_initialized": true,
  "timestamp": 1706739200.0
}
```

#### 3. WebSocket ç«¯ç‚¹ `WS /ws`
æ”¯æŒå®æ—¶æµå¼æŸ¥è¯¢ï¼Œä¸å‰ç«¯å®Œå…¨å…¼å®¹

---

## ğŸ”Œ WebSocket åè®®

### å‰ç«¯å‘é€
```json
{
  "action": "query",
  "question": "æœ‰å¤šå°‘åœ¨èŒå‘˜å·¥ï¼Ÿ"
}
```

### åç«¯æ¨é€
åç«¯ä¼šå®æ—¶æ¨é€å¤šç§ç±»å‹çš„æ¶ˆæ¯ï¼Œå‰ç«¯ä¼šæ ¹æ®ä¸åŒç±»å‹è¿›è¡Œå±•ç¤ºï¼š

1. **connected** - è¿æ¥æˆåŠŸ
```json
{
  "type": "connected",
  "message": "å·²è¿æ¥åˆ° ERP Agent æœåŠ¡",
  "timestamp": 1706739200.0
}
```

2. **start** - æŸ¥è¯¢å¼€å§‹
```json
{
  "type": "start",
  "user_question": "æœ‰å¤šå°‘åœ¨èŒå‘˜å·¥ï¼Ÿ",
  "timestamp": 1706739200.0
}
```

3. **iteration_start** - è¿­ä»£å¼€å§‹
```json
{
  "type": "iteration_start",
  "iteration": 1,
  "timestamp": 1706739200.1
}
```

4. **thought** - æ€è€ƒè¿‡ç¨‹
```json
{
  "type": "thought",
  "thought": "éœ€è¦ç»Ÿè®¡åœ¨èŒå‘˜å·¥æ•°é‡",
  "iteration": 1,
  "timestamp": 1706739200.2
}
```

5. **sql_executing** - SQL æ‰§è¡Œ
```json
{
  "type": "sql_executing",
  "sql": "SELECT COUNT(*) FROM employees WHERE leave_date IS NULL",
  "iteration": 1,
  "timestamp": 17067392020.3
}
```

6. **sql_result** - SQL ç»“æœ
```json
{
  "type": "sql_result",
  "row_count": 89,
  "data": [[89]],
  "success": true,
  "iteration": 1,
  "timestamp": 1706739200.4
}
```

7. **answer** - æœ€ç»ˆç­”æ¡ˆ
```json
{
  "type": "answer",
  "answer": "å…¬å¸ç›®å‰æœ‰ 89 ååœ¨èŒå‘˜å·¥ã€‚",
  "iteration": 1,
  "timestamp": 1706739200.5
}
```

8. **final** - æŸ¥è¯¢å®Œæˆ
```json
{
  "type": "final",
  "success": true,
  "iterations": 1,
  "total_time": 0.8,
  "answer": "å…¬å¸ç›®å‰æœ‰ 89 ååœ¨èŒå‘˜å·¥ã€‚",
  "timestamp": 1706739200.6
}
```

9. **error** - é”™è¯¯ä¿¡æ¯
```json
{
  "type": "error",
  "error": "é”™è¯¯è¯¦æƒ…",
  "timestamp": 1706739200.0
}
```

---

## ğŸš€ å¯åŠ¨æ–¹å¼

### æ–¹å¼ä¸€ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

#### Windows
```bash
# å¯åŠ¨åç«¯
start_backend.bat

# å¯åŠ¨å‰ç«¯ï¼ˆæ–°ç»ˆç«¯ï¼‰
start_frontend.bat
```

#### Linux / macOS
```bash
# å¯åŠ¨åç«¯
cd erp_agent && python main.py

# å¯åŠ¨å‰ç«¯ï¼ˆæ–°ç»ˆç«¯ï¼‰
cd frontend && npm install && npm run dev
```

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨å¯åŠ¨

#### åç«¯
```bash
cd erp_agent
python main.py
```

æœåŠ¡å°†è¿è¡Œåœ¨ï¼š
- WebSocket: ws://0.0.0.0:8000/ws
- API æ–‡æ¡£: http://0.0.0.0:8000/docs
- å¥åº·æ£€æŸ¥: http://0.0.0.0:8000/health

#### å‰ç«¯
```bash
cd frontend
npm install
npm run dev
```

è®¿é—®: http://localhost:3000

---

## ğŸ“Š æœåŠ¡å¯åŠ¨æ—¥å¿—

æˆåŠŸå¯åŠ¨åï¼Œä½ ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

```
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘         ERP Agent WebSocket Service v0.1.0                   â•‘
    â•‘          åŸºäº Kimi-K2 çš„æ™ºèƒ½æ•°æ®æŸ¥è¯¢åŠ©æ‰‹                      â•‘
    â•‘                    WebSocket API                               â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ å·²åŠ è½½ç¯å¢ƒé…ç½®: C:\Users\86159\Desktop\erp_agent\erp_agent\.env
æ­£åœ¨æ£€æŸ¥ç¯å¢ƒé…ç½®...
âœ“ ç¯å¢ƒå˜é‡é…ç½®å®Œæ•´
æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...
âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸï¼ˆå…± 100 åå‘˜å·¥ï¼‰

âœ“ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå‡†å¤‡å¯åŠ¨ WebSocket æœåŠ¡ï¼

[32m2026-01-31 22:28:26[0m | [1mINFO    [0m | [36merp_agent.utils.logger[0m:[36msetup_logger[0m:[36m89[0m | [1mæ—¥å¿—ç³»ç»Ÿå·²åˆå§‹åŒ– [çº§åˆ«: INFO, æ–‡ä»¶: logs/agent.log][0m
[32m2026-01-31 22:28:26[0m | [1mINFO    [0m | [36merp_agent.core.agent[0m:[36m__init__[0m:[36m114[0m | [1mERP Agent å·²åˆå§‹åŒ–[0m
[32m2026-01-31 22:28:26[0m | [1mINFO    [0m | [36merp_agent.core.agent[0m:[36m__init__[0m:[36m115[0m | [1mæœ€å¤§è¿­ä»£æ¬¡æ•°: 5[0m
INFO:     Started server process [31996]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

WebSocket è¿æ¥æ—¥å¿—ï¼š
```
[123456789] å®¢æˆ·ç«¯å·²è¿æ¥
[123456789] æ”¶åˆ°æŸ¥è¯¢: æœ‰å¤šå°‘åœ¨èŒå‘˜å·¥ï¼Ÿ...
[123456789] å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
```

---

## ğŸ”„ å…¼å®¹æ€§è¯´æ˜

### ä¿ç•™åŸæœ‰åŠŸèƒ½

åŸå§‹ `main.py.backup` åŒ…å«äº†å®Œæ•´çš„å‘½ä»¤è¡Œäº¤äº’ç•Œé¢ï¼ŒåŒ…æ‹¬ï¼š
- äº¤äº’å¼ CLI æ¨¡å¼
- `help` å‘½ä»¤
- `test` å‘½ä»¤ï¼ˆè¿è¡Œæµ‹è¯•é—®é¢˜ï¼‰
- `stream` å‘½ä»¤ï¼ˆåˆ‡æ¢æµå¼è¾“å‡ºï¼‰
- `exit` å‘½ä»¤

å¦‚æœéœ€è¦æ¢å¤å‘½ä»¤è¡Œç‰ˆæœ¬ï¼Œåªéœ€ï¼š
```bash
cp erp_agent/main.py.backup erp_agent/main.py
```

### æ–°å¢åŠŸèƒ½

æ–° `main.py` æ–°å¢äº†ï¼š
- FastAPI åº”ç”¨æ¡†æ¶
- WebSocket å®æ—¶é€šä¿¡
- REST API ç«¯ç‚¹
- è‡ªåŠ¨é‡è¿æ”¯æŒ

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### 1. å¥åº·æ£€æŸ¥æµ‹è¯•

ä½¿ç”¨æµè§ˆå™¨æˆ– curl è®¿é—®ï¼š
```bash
curl http://localhost:8000/health
```

é¢„æœŸè¾“å‡ºï¼š
```json
{
  "status": "healthy",
  "agent_initialized": true,
  "timestamp": 1706739200.0
}
```

### 2. WebSocket æµ‹è¯•

å¯åŠ¨å‰ç«¯åï¼Œåœ¨æµè§ˆå™¨ä¸­ï¼š
1. è®¿é—® http://localhost:3000
2. è¾“å…¥é—®é¢˜: "æœ‰å¤šå°‘åœ¨èŒå‘˜å·¥ï¼Ÿ"
3. ç‚¹å‡»"æäº¤æŸ¥è¯¢"æˆ–æŒ‰ Ctrl+Enter
4. è§‚å¯Ÿæµå¼è¾“å‡ºå’Œç»“æœ

### 3. API æ–‡æ¡£æµ‹è¯•

è®¿é—®: http://localhost:8000/docs
- æŸ¥çœ‹ FastAPI è‡ªåŠ¨ç”Ÿæˆçš„ API æ–‡æ¡£
- å¯ä»¥ç›´æ¥åœ¨ç½‘é¡µä¸­æµ‹è¯• API

---

## ğŸ“ æ”¹é€ åçš„æ–‡ä»¶ç»“æ„

```
erp_agent/
â”œâ”€â”€ erp_agent/
â”‚   â”œâ”€â”€ main.py                  # âœ¨ FastAPI WebSocket æœåŠ¡ï¼ˆæ–°ï¼‰
â”‚   â”œâ”€â”€ main.py.backup           # ğŸ“¦ åŸå§‹ CLI ç‰ˆæœ¬ï¼ˆå¤‡ä»½ï¼‰
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â””â”€â”€ agent.py             # ERPAgent æ ¸å¿ƒé€»è¾‘ï¼ˆæœªæ”¹åŠ¨ï¼‰
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ llm.py               # LLM é…ç½®ï¼ˆæœªæ”¹åŠ¨ï¼‰
â”‚   â”‚   â””â”€â”€ database.py          # æ•°æ®åº“é…ç½®ï¼ˆæœªæ”¹åŠ¨ï¼‰
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ frontend/                    # âœ¨ Vue 3 å‰ç«¯ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ composables/
â”‚   â”‚   â””â”€â”€ views/
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ vite.config.js
â”‚
â”œâ”€â”€ requirements.txt             # âœ¨ å·²æ›´æ–°ï¼ˆæ–°å¢ fastapi ç­‰ï¼‰
â”œâ”€â”€ start_backend.bat            # âœ¨ åç«¯å¯åŠ¨è„šæœ¬
â””â”€â”€ start_frontend.bat           # âœ¨ å‰ç«¯å¯åŠ¨è„šæœ¬
```

---

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

1. **é›¶ä¾µå…¥å¼æ”¹é€ ** - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®Œå…¨æœªæ”¹åŠ¨
2. **å‘åå…¼å®¹** - ä¿ç•™äº†åŸå§‹ CLI ç‰ˆæœ¬
3. **å®æ—¶é€šä¿¡** - WebSocket æä¾›çœŸæ­£çš„å®æ—¶æµå¼è¾“å‡º
4. **é«˜æ€§èƒ½** - ä½¿ç”¨ uvicorn ASGI æœåŠ¡å™¨
5. **æ˜“äºæ‰©å±•** - FastAPI æ¡†æ¶ä¾¿äºæ·»åŠ æ–°çš„ API ç«¯ç‚¹
6. **å®Œæ•´æ–‡æ¡£** - FastAPI è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£

---

## ğŸ› é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: ç«¯å£è¢«å ç”¨

**é”™è¯¯ä¿¡æ¯**: `Address already in use`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# Windows
netstat -ano | findstr :8000
taskkill /PID <PID> /F

# Linux / macOS
lsof -i :8000
kill -9 <PID>
```

### é—®é¢˜ 2: WebSocket è¿æ¥å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨
2. æ£€æŸ¥å‰ç«¯ `.env` ä¸­çš„ `VITE_WS_URL` æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### é—®é¢˜ 3: æ•°æ®åº“è¿æ¥å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ PostgreSQL æœåŠ¡æ˜¯å¦å¯åŠ¨
2. æ£€æŸ¥ `.env` ä¸­çš„æ•°æ®åº“é…ç½®
3. ç¡®ä¿æ•°æ®åº“å·²åˆå§‹åŒ–

### é—®é¢˜ 4: Agent åˆå§‹åŒ–å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ `logs/agent.log`

---

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®

1. **æ·»åŠ è®¤è¯åŠŸèƒ½** - å®ç°ç”¨æˆ·ç™»å½•å’Œæƒé™ç®¡ç†
2. **æ·»åŠ é€Ÿç‡é™åˆ¶** - é˜²æ­¢ API æ»¥ç”¨
3. **æ·»åŠ æ—¥å¿—è½®è½¬** - é¿å…æ—¥å¿—æ–‡ä»¶è¿‡å¤§
4. **æ·»åŠ ç›‘æ§æŒ‡æ ‡** - Prometheus + Grafana
5. **éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ** - Docker + Nginx

---

## ğŸ‰ å®ŒæˆçŠ¶æ€

- âœ… åç«¯æ”¹é€ å®Œæˆ
- âœ… å‰ç«¯å¼€å‘å®Œæˆ
- âœ… WebSocket é€šä¿¡æµ‹è¯•é€šè¿‡
- âœ… å¥åº·æ£€æŸ¥åŠŸèƒ½æ­£å¸¸
- âœ… API æ–‡æ¡£ç”ŸæˆæˆåŠŸ

**æ•´ä¸ª ERP Agent é¡¹ç›®çš„å‰åç«¯æ”¹é€ å·²å…¨éƒ¨å®Œæˆï¼**

---

**åç«¯æ”¹é€ æ—¶é—´**: 2026-01-31  
**åç«¯ç‰ˆæœ¬**: 0.1.0  
**çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œå¯æ­£å¸¸ä½¿ç”¨
